@model EngineeringThesis.Contracts.Auth.PasswordlessLoginConfirmRequest
@{
    ViewData["Title"] = "Logowanie bez hasła";
}

<h2 class="mb-4">Logowanie (bez hasła)</h2>

<div id="alertBox" class="alert d-none" role="alert"></div>

<form id="pwlsForm" novalidate>
    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

    <div class="mb-3">
        <label asp-for="Identifier" class="form-label">E-mail lub nazwa użytkownika</label>
        <input asp-for="Identifier" class="form-control" autocomplete="username" id="Identifier" />
        <span asp-validation-for="Identifier" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label" id="SecurityQuestionLabel">Odpowiedź na pytanie kontrolne</label>
        <input asp-for="SecurityAnswer" class="form-control" id="SecurityAnswer" />
        <span asp-validation-for="SecurityAnswer" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Code" class="form-label">Kod z e-maila</label>
        <div class="input-group">
            <input asp-for="Code" class="form-control" id="Code" inputmode="numeric" autocomplete="one-time-code" />
            <button type="button" id="sendCodeBtn" class="btn btn-outline-secondary">Wyślij kod</button>
        </div>
        <div class="form-text" id="codeHint" style="display:none;"></div>
        <span asp-validation-for="Code" class="text-danger"></span>
    </div>

    <div id="twoFactorBlock" style="display:none;">
        <div class="mb-3">
            <label asp-for="TwoFactorCode" class="form-label">Kod TOTP (6 cyfr)</label>
            <input asp-for="TwoFactorCode"
                   id="TwoFactorCode"
                   class="form-control"
                   inputmode="numeric" pattern="[0-9]{6}" maxlength="6"
                   autocomplete="one-time-code" />
            <span asp-validation-for="TwoFactorCode" class="text-danger"></span>
        </div>
    </div>

    <button type="submit" id="loginBtn" class="btn btn-primary">
        <span class="spinner-border spinner-border-sm me-2 d-none" id="loginSpinner" aria-hidden="true"></span>
        Zaloguj
    </button>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const form = document.getElementById('pwlsForm');
            const btn = document.getElementById('loginBtn');
            const spinner = document.getElementById('loginSpinner');
            const alertBox = document.getElementById('alertBox');
            const twoFactorBlock = document.getElementById('twoFactorBlock');
            const sendCodeBtn = document.getElementById('sendCodeBtn');
            const codeHint = document.getElementById('codeHint');
            const Identifier = document.getElementById('Identifier');

            function showAlert(msg, type) {
                alertBox.className = 'alert alert-' + type;
                alertBox.textContent = msg;
                alertBox.classList.remove('d-none');
            }
            function clearAlert() {
                alertBox.className = 'alert d-none';
                alertBox.textContent = '';
            }
            function setBusy(b) {
                btn.disabled = b;
                sendCodeBtn.disabled = b;
                spinner.classList.toggle('d-none', !b);
            }
            function clearServerErrors() {
                const spans = form.querySelectorAll('span.field-validation-error, span.text-danger');
                spans.forEach(s => { if (!s.classList.contains('text-danger')) return; s.textContent = ''; });
                const summary = form.querySelector('[data-valmsg-summary="true"]');
                if (summary) summary.innerHTML = '';
            }
            function applyModelStateErrors(errors) {
                for (const [field, msgs] of Object.entries(errors)) {
                    const span = form.querySelector(`[data-valmsg-for="${field}"]`);
                    if (span) {
                        span.textContent = msgs.join(' ');
                        span.classList.add('field-validation-error');
                    }
                }
            }

            async function sendCode() {
                clearAlert();
                const identifier = (Identifier.value || '').trim();
                if (!identifier) { showAlert('Podaj e-mail lub login, aby wysłać kod.', 'warning'); return; }

                sendCodeBtn.disabled = true;
                try {
                    const r = await fetch('/api/auth/passwordless/request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ Identifier: identifier })
                    });
                    const data = await r.json().catch(() => ({}));

                    if (r.status === 429) {
                        showAlert(data?.message || 'Za często prosisz o kod.', 'warning');
                        return;
                    }

                    codeHint.style.display = '';
                    codeHint.textContent = 'Kod aktywny przez 15 minut. Sprawdź wirtualną pocztę.';
                    showAlert(data?.message || 'Jeśli konto istnieje, kod został wysłany.', 'info');
                } catch {
                    showAlert('Błąd sieci. Spróbuj ponownie.', 'danger');
                } finally {
                    sendCodeBtn.disabled = false;
                }
            }

            sendCodeBtn.addEventListener('click', sendCode);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                clearAlert();
                clearServerErrors();

                if (typeof $ !== 'undefined' && $(form).valid && !$(form).valid()) {
                    return;
                }

                const payload = {
                    Identifier: document.getElementById('Identifier').value.trim(),
                    SecurityAnswer: document.getElementById('SecurityAnswer').value,
                    Code: document.getElementById('Code').value,
                    TwoFactorCode: twoFactorBlock.style.display !== 'none'
                        ? (document.getElementById('TwoFactorCode').value || null)
                        : null
                };

                setBusy(true);
                try {
                    const r = await fetch('/api/auth/passwordless/confirm', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });

                    if (r.ok) { location.href = '/'; return; }

                    const data = await r.json().catch(() => ({}));
                    const msg = (data && (data.message || data.error || JSON.stringify(data))) || 'Błąd logowania.';

                    if (r.status === 400 && data?.errors) {
                        applyModelStateErrors(data.errors);
                        showAlert('Popraw zaznaczone pola.', 'warning');
                        return;
                    }

                    if (r.status === 401 && String(msg).toLowerCase().includes('wymagany kod 2fa')) {
                        twoFactorBlock.style.display = '';
                        showAlert('Włączone 2FA — podaj 6-cyfrowy kod i spróbuj ponownie.', 'info');
                        return;
                    }

                    if (r.status === 429) {
                        showAlert(msg, 'warning');
                        return;
                    }

                    showAlert(msg, 'danger');
                } catch {
                    showAlert('Błąd sieci. Spróbuj ponownie.', 'danger');
                } finally {
                    setBusy(false);
                }
            });
        })();
    </script>
}

